name: Upgrade podspec version workflow
on: create
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@master
      
    - name: Get and check if branch name is an `release/*`
      uses: uynguyen-wonderlabs/get-branch-name-github-action@master
      id: get-branch
      
    - name: Check and get release version only
      if: ${{ steps.get-branch.outputs.is_release_branch == 'YES' }}
      id: get-release-version
      run: |
        version=$(echo ${{ steps.get-branch.outputs.branch }} | sed -e "s/release\///g")
        echo "::set-output name=new_release_version::${version}"
        
    - name: Find and replace the current spec version to new version
      if: ${{ steps.get-branch.outputs.is_release_branch == 'YES' }}
      uses: shitiomatic/str-replace@master
      with:
        find: "\\t*spec.version\\s*=\\s\"[\\S]*\""
        replace: "spec.version      = \"${{ steps.get-release-version.outputs.new_release_version }}\""
        include: ".podspec"
     
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v3
      with:
          token: ${{ secrets.PAT }}
          commit-message: Update report
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: example-patches
          delete-branch: true
          title: "Upgrade podspec version to ${{ steps.get-release-version.outputs.new_release_version }}"
          body: |
            Update report
            - Upgrade podspec version to ${{ steps.get-release-version.outputs.new_release_version }}
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: |
            report
            automated pr
          milestone: 1
          draft: false

    - name: Check outputs
      run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
   
